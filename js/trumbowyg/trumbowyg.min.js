$.trumbowyg={langs:{en:{viewHTML:"View HTML",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image...",insertVideo:"Insert Video...",link:"Link",createLink:"Insert link...",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",insertHorizontalRule:"Insert horizontal rule",fullscreen:"fullscreen",close:"Close",confirm:"Confirm",cancel:"Cancel"}}};(function(c){c.fn.trumbowyg=function(e){return this.each(function(){var g=c(this);if(!g.data("trumbowyg")){g.data("trumbowyg",new b(this,e))}})};c.fn.destroyTrumbowyg=function(){this.data("trumbowyg").destroy()};c.fn.getCode=function(){return this.data("trumbowyg").getCode()};var b=function(e,g){this.$e=c(e);this.$creator=c(e);if(typeof g==="undefined"||typeof g.lang==="undefined"||typeof c.trumbowyg.langs[g.lang]==="undefined"){this.lang=c.trumbowyg.langs.en}else{this.lang=c.extend(true,{},c.trumbowyg.langs.en,c.trumbowyg.langs[g.lang])}this.glob={btnsGrps:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]}};this.o=c.extend(true,{lang:"en",dir:"ltr",duration:200,mobile:false,tablet:true,closable:false,fullscreenable:true,fixedbtnPane:false,fixedFullWidth:false,semantic:false,resetCss:false,autoAjustHeight:false,prefix:"trumbowyg-",convertLink:true,btns:["viewHTML","|","formatting","|",this.glob.btnsGrps.design,"|","link","|","insertImage","|",this.glob.btnsGrps.justify,"|",this.glob.btnsGrps.lists,"|","insertHorizontalRule"],btnsAdd:[],btnsDef:{viewHTML:{func:"toggle"},formatting:{dropdown:{defaultFunc:"formatBlock",p:{},blockquote:{},h1:{title:this.lang.header+" 1"},h2:{title:this.lang.header+" 2"},h3:{title:this.lang.header+" 3"},h4:{title:this.lang.header+" 4"}}},bold:{},italic:{},underline:{},strikethrough:{},strong:{func:"bold"},em:{func:"italic"},link:{dropdown:{createLink:{},unlink:{}}},insertImage:{},justifyLeft:{},justifyCenter:{},justifyRight:{},justifyFull:{},unorderedList:{func:"insertUnorderedList"},orderedList:{func:"insertOrderedList"},insertHorizontalRule:{}}},g);if(this.o.semantic){this.o.btns=["viewHTML","|","formatting","|",this.glob.btnsGrps.semantic,"|","link","|","insertImage","|",this.glob.btnsGrps.justify,"|",this.glob.btnsGrps.lists,"|","insertHorizontalRule"]}this.init()};b.prototype={init:function(){this.height=this.$e.css("height");if(this.isEnabled()){this.buildEditor(true);return}this.buildEditor();this.buildbtnPane();this.fixedbtnPaneEvents();this.buildOverlay()},buildEditor:function(g){if(g===true){if(!this.$e.is("textarea")){var e=this.buildTextarea().val(this.$e.val());this.$e.hide().after(e)}return}this.$box=c("<div/>",{"class":this.o.prefix+"box "+this.o.prefix+this.o.lang+" trumbowyg"});this.isTextarea=true;if(this.$e.is("textarea")){this.$editor=c("<div/>")}else{this.$editor=this.$e;this.$e=this.buildTextarea().val(this.$e.val());this.isTextarea=false}this.$e.hide().addClass(this.o.prefix+"textarea");var h="";if(this.isTextarea){h=this.$e.val();this.$box.insertAfter(this.$e).append(this.$editor).append(this.$e)}else{h=this.$editor.html();this.$box.insertAfter(this.$editor).append(this.$e).append(this.$editor);this.syncCode()}this.$editor.addClass(this.o.prefix+"editor").attr("contenteditable",true).attr("dir",this.o.dir).html(h);if(this.o.resetCss){this.$editor.addClass(this.o.prefix+"reset-css")}if(!this.o.autoAjustHeight){this.$editor.css({height:this.height,overflow:"auto"});this.$e.css({height:this.height,overflow:"auto"})}var i=this;this.$editor.on("dblclick","img",function(){var j=c(this);i.buildInsert(i.lang.insertImage,{url:{value:j.attr("src")},alt:{label:"Alt",name:"alt",value:j.attr("alt")}},function(k){j.attr("src",k.url);j.attr("alt",k.alt)});return false});this.$editor.on("mousedown",function(j){i.sementicCode()})},buildTextarea:function(){return c('<textarea name="'+this.$e.attr("id")+'"></textarea>',{height:this.height})},buildbtnPane:function(){if(this.o.btns===false){return}this.$btnPane=c("<ul/>",{"class":this.o.prefix+"button-pane"});c.each(this.o.btns.concat(this.o.btnsAdd),c.proxy(function(h,g){if(!c.isArray(g)){g=[g]}c.each(g,c.proxy(function(l,k){try{var j=c("<li/>");if(k=="|"){j.addClass(this.o.prefix+"separator")}else{if(k=="viewHTML"){j.addClass(this.o.prefix+"not-disable")}j.append(this.buildbtn(k))}this.$btnPane.append(j)}catch(m){}},this))},this));var e=c("<li/>",{"class":this.o.prefix+"not-disable "+this.o.prefix+"buttons-right"});if(this.o.fullscreenable){e.append(this.buildRightbtn("fullscreen").on("click",c.proxy(function(j){var g=this.o.prefix+"fullscreen";this.$box.toggleClass(g);if(this.$box.hasClass(g)){c("body").css("overflow","hidden");this.$box.css({position:"fixed",top:0,left:0,width:"100%",height:"100%",margin:0,padding:0,zIndex:10});c([this.$editor,this.$e]).each(function(){c(this).css({height:"100%",overflow:"auto"})});this.$btnPane.css({width:"100%"})}else{c("body").css("overflow","auto");this.$box.removeAttr("style");if(!this.o.autoAjustHeight){var i=this.height;c([this.$editor,this.$e]).each(function(){c(this).css({height:i})})}}c(window).trigger("scroll")},this)))}if(this.o.closable){e.append(this.buildRightbtn("close").on("click",c.proxy(function(g){if(this.$box.hasClass(cssClass)){c("body").css("overflow","auto")}this.destroy()},this)))}this.$btnPane.append(e);this.$box.prepend(this.$btnPane)},buildbtn:function(g){var k=this.o.btnsDef[g];var i=this;var h=c("<a/>",{href:"javascript:void(null);","class":this.o.prefix+g+"-button",text:k.text||k.title||this.lang[g]||g,title:k.title||k.text||this.lang[g]||g,mousedown:function(m){if(!k.dropdown||i.$box.find("."+g+"-"+i.o.prefix+"dropdown").is(":hidden")){c("body").trigger("mousedown")}if(i.$btnPane.hasClass(i.o.prefix+"disable")&&!c(this).parent().hasClass(i.o.prefix+"not-disable")){return false}i.execCommand((k.dropdown?"dropdown":"")||k.func||g,k.param||g);m.stopPropagation();m.preventDefault();return false}});if(k.dropdown){var e=this.o.prefix+"dropdown "+this.o.prefix+"fixed-top";var l=c("<div/>",{"class":g+"-"+e+" "+e});l.data("visible",false);for(var j in k.dropdown){if(c.isObject(k.dropdown[j])){l.append(this.buildSubbtn(k.dropdown,j))}}this.$box.append(l.hide())}return h},buildSubbtn:function(h,e){c("body").trigger("mousedown");var g=h[e];return c("<a/>",{href:"javascript:void(null);",text:g.text||g.title||this.lang[e]||e,title:g.title||g.text||this.lang[e]||e,mousedown:c.proxy(function(i){c("body").trigger("mousedown");this.execCommand(h.defaultFunc||g.func||e,g.param||e);i.stopPropagation();i.preventDefault();return false},this)})},buildRightbtn:function(e){return c("<a/>",{href:"javascript:void(null);","class":this.o.prefix+e+"-button",title:this.lang[e],text:this.lang[e]})},buildOverlay:function(){return this.$overlay=c("<div/>",{"class":this.o.prefix+"overlay"}).css({top:this.$btnPane.css("height"),height:this.$editor.outerHeight()}).appendTo(this.$box)},showOverlay:function(){c(window).trigger("scroll");this.$overlay.fadeIn(200)},hideOverlay:function(){this.$overlay.fadeOut(200)},fixedbtnPaneEvents:function(){if(!this.o.fixedbtnPane){return}this.isFixed=false;c(window).on("scroll",c.proxy(function(i){if(!this.$box){return}this.syncCode();var h=c(window).scrollTop();var j=this.$box.offset().top+2;var g=(h-j>0)&&((h-j-parseInt(this.height.replace("px","")))<0);if(g){if(!this.isFixed){this.isFixed=true;this.$btnPane.css({position:"fixed",top:0,left:(this.o.fixedFullWidth)?"0":"auto",width:(this.o.fixedFullWidth)?"100%":this.$box.css("width"),zIndex:7});this.$editor.css({marginTop:this.$btnPane.css("height")});this.$e.css({marginTop:this.$btnPane.css("height")})}c("."+this.o.prefix+"fixed-top",this.$box).css({position:this.o.fixedFullWidth?"fixed":"absolute",top:this.o.fixedFullWidth?this.$btnPane.css("height"):parseInt(this.$btnPane.css("height").replace("px",""))+(h-j)+"px",zIndex:15})}else{if(this.isFixed){this.isFixed=false;this.$btnPane.css({position:"relative"});this.$editor.css({marginTop:0});this.$e.css({marginTop:0});c("."+this.o.prefix+"fixed-top",this.$box).css({position:"absolute",top:this.$btnPane.css("height")})}}},this))},destroy:function(){var e=this.getCode();if(this.isTextarea){this.$box.after(this.$e.css({height:this.height}).val(e).removeClass(this.o.prefix+"textarea").show())}else{this.$box.after(this.$editor.css({height:this.height}).removeClass(this.o.prefix+"editor").attr("contenteditable",false).html(e).show())}this.$box.remove();this.$creator.removeData("trumbowyg")},toggle:function(){this.sementicCode();this.$editor.toggle();this.$e.toggle();this.$btnPane.toggleClass(this.o.prefix+"disable")},dropdown:function(e){var h=this.$box.find("."+e+"-"+this.o.prefix+"dropdown");var g=this.$btnPane.find("."+this.o.prefix+e+"-button");if(h.is(":hidden")){g.addClass(this.o.prefix+"active");h.css({position:"absolute",top:this.$btnPane.css("height"),left:(this.o.fixedFullWidth&&this.isFixed)?g.offset().left+"px":(g.offset().left-this.$btnPane.offset().left)+"px"}).show();c(window).trigger("scroll");c("body").on("mousedown",c.proxy(function(i){c("."+this.o.prefix+"dropdown").hide();c("."+this.o.prefix+"active").removeClass(this.o.prefix+"active");c("body").off("mousedown")},this))}else{c("body").trigger("mousedown")}},getCode:function(){return this.$e.val()},setCode:function(e){this.$e.val(e)},syncCode:function(){if(this.$editor.is(":visible")){this.$e.val(this.$editor.html())}else{this.$editor.html(this.$e.val())}if(this.o.autoAjustHeight){this.height=this.$editor.css("height");this.$e.css({height:this.height})}},sementicCode:function(){this.syncCode();if(this.o.semantic){this.sementicTag("b","strong");this.sementicTag("i","em");this.$e.val(this.$editor.html())}},sementicTag:function(e,g){c(e,this.$editor).each(function(){c(this).replaceWith(function(){return"<"+g+">"+c(this).html()+"</"+g+">"})})},createLink:function(){this.saveSelection();this.buildInsert(this.lang.insertImage,{title:{label:"Title",name:"title",value:this.selection},text:{label:"Text",name:"text",value:this.selection}},"createLink")},formatBlock:function(e){if(c.browser.msie){e="<"+e+">"}document.execCommand("formatBlock",false,e);this.syncCode()},insertImage:function(){this.saveSelection();this.buildInsert(this.lang.insertImage,{alt:{label:"Alt",name:"alt",value:this.selection}},"insertImage")},buildInsert:function(j,e,i){e=c.extend(true,{url:{label:"URL",name:"url",value:"http://"}},e);var g="";for(f in e){f=e[f];g+="<label>"+f.label+' : <input type="text" name="'+f.name+'" value="'+(f.value||"")+'"></label>'}var h=this.openModal(j,g);h.on(this.o.prefix+"confirm",c.proxy(function(o,k){var n=c(k);var l={};e.url={};for(f in e){l[f]=c('input[name="'+f+'"]',n).val()}if(l.url!="http://"){this.restoreSelection();if(c.isString(i)){document.execCommand(i,false,l.url)}else{i(l)}this.syncCode();this.closeModal();h.off(this.o.prefix+"confirm")}else{n.append('<span class="error">Invalid URL</span>')}},this));h.one(this.o.prefix+"cancel",c.proxy(function(){h.off(this.o.prefix+"confirm");this.closeModal();this.restoreSelection()},this))},execCommand:function(g,i){if(g!="dropdown"){this.$editor.focus()}try{this[g](i)}catch(h){try{g(i)}catch(h){this.$editor.focus();document.execCommand(g,false,i)}}this.syncCode()},openModal:function(i,h){this.saveSelection();this.showOverlay();this.$btnPane.addClass(this.o.prefix+"disable");c("."+this.o.prefix+"not-disable",this.$btnPane).not("."+this.o.prefix+"buttons-right").removeClass(this.o.prefix+"not-disable").addClass(this.o.prefix+"not-disable-old");var g=c("<div/>",{"class":this.o.prefix+"modal "+this.o.prefix+"fixed-top"}).css({top:this.$btnPane.css("height")}).appendTo(this.$box);var e=c("<div/>",{"class":this.o.prefix+"modal-box",html:h}).css({top:"-"+g.css("height")}).appendTo(g).animate({top:0},this.o.duration);c("<span/>",{text:i,"class":this.o.prefix+"modal-title"}).prependTo(e);e.find("input:first").focus();this.buildModalbtn("cancel",e);this.buildModalbtn("confirm",e);c("body").trigger("scroll");return e},buildModalbtn:function(e,g){return c("<a/>",{href:"javascript:void(null);","class":this.o.prefix+"modal-button "+this.o.prefix+"modal-"+e,text:this.lang[e]||e,title:this.lang[e]||e,click:c.proxy(function(h){g.trigger(this.o.prefix+e,g)},this)}).appendTo(g)},closeModal:function(){this.$btnPane.removeClass(this.o.prefix+"disable");c("."+this.o.prefix+"not-disable-old",this.$btnPane).removeClass(this.o.prefix+"not-disable-old").addClass(this.o.prefix+"not-disable");that=this;$modalBox=c("."+this.o.prefix+"modal-box",this.$box);$modalBox.animate({top:"-"+$modalBox.css("height")},this.o.duration,function(){c(this).parent().remove();that.hideOverlay()})},saveSelection:function(){this.selection=null;if(window.getSelection){var e=window.getSelection();if(e.getRangeAt&&e.rangeCount){this.selection=e.getRangeAt(0)}}else{if(document.selection&&document.selection.createRange){this.selection=document.selection.createRange()}}},restoreSelection:function(){range=this.selection;if(range){if(window.getSelection){var e=window.getSelection();e.removeAllRanges();e.addRange(range)}else{if(document.selection&&range.select){range.select()}}}},isEnabled:function(){var e="iPhone|iPod|Android|BlackBerry|WindowssPhone|ZuneWP7";var h=new RegExp("(iPad|webOS)");var g=new RegExp("("+e+")");return(this.o.tablet===true&&h.test(navigator.userAgent))||(this.o.mobile===true&&g.test(navigator.userAgent))}};var d=Object.prototype.toString,a=Object.prototype.hasOwnProperty;c.isObject=function(g){if(d.call(g)!=="[object Object]"){return false}var e;for(e in g){}return !e||a.call(g,e)};c.isString=function(e){return typeof(e)==="string"}})(jQuery);