$.trumbowyg={langs:{en:{viewHTML:"View HTML",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphasis",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image...",insertVideo:"Insert Video...",link:"Link",createLink:"Insert link...",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",insertHorizontalRule:"Insert horizontal rule",fullscreen:"fullscreen",close:"Close",confirm:"Confirm",cancel:"Cancel"}}};(function(c){c.fn.trumbowyg=function(e){return this.each(function(){var f=c(this);if(!f.data("trumbowyg")){f.data("trumbowyg",new b(this,e))}})};c.fn.destroyTrumbowyg=function(){this.data("trumbowyg").destroy()};c.fn.getCode=function(){return this.data("trumbowyg").getCode()};var b=function(e,f){this.$e=c(e);this.$creator=c(e);if(typeof f==="undefined"||typeof f.lang==="undefined"||typeof c.trumbowyg.langs[f.lang]==="undefined"){this.lang=c.trumbowyg.langs.en}else{this.lang=c.extend(true,{},c.trumbowyg.langs.en,c.trumbowyg.langs[f.lang])}this.global={buttonsGroups:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]}};this.cssClass={editorBox:"box",editorEditor:"editor",editorTextarea:"textarea",buttonPane:"button-pane",separator:"separator",dropdown:"dropdown",fullscreen:"fullscreen",close:"close",notDisable:"not-disable",buttonsRight:"buttons-right",modal:"modal",fixedTop:"fixed-top"};this.opts=c.extend(true,{lang:"en",dir:"ltr",mobile:false,tablet:true,closable:false,fullscreenable:true,fixedButtonPane:false,fixedFullWidth:false,semantic:false,resetCss:false,autoAjustHeight:false,prefix:"trumbowyg-",convertLink:true,buttons:["viewHTML","|","formatting","|",this.global.buttonsGroups.design,"|","link","|","insertImage","|",this.global.buttonsGroups.justify,"|",this.global.buttonsGroups.lists,"|","insertHorizontalRule"],buttonsAdd:[],buttonsDef:{viewHTML:{func:"toggle"},formatting:{dropdown:{defaultFunc:"formatBlock",p:{},blockquote:{},h1:{title:this.lang.header+" 1"},h2:{title:this.lang.header+" 2"},h3:{title:this.lang.header+" 3"},h4:{title:this.lang.header+" 4"}}},bold:{},italic:{},underline:{},strikethrough:{},strong:{func:"bold"},em:{func:"italic"},link:{dropdown:{createLink:{},unlink:{}}},insertImage:{},justifyLeft:{},justifyCenter:{},justifyRight:{},justifyFull:{},unorderedList:{func:"insertUnorderedList"},orderedList:{func:"insertOrderedList"},insertHorizontalRule:{}}},f);if(this.opts.semantic){this.opts.buttons=["viewHTML","|","formatting","|",this.global.buttonsGroups.semantic,"|","link","|","insertImage","|",this.global.buttonsGroups.justify,"|",this.global.buttonsGroups.lists,"|","insertHorizontalRule"]}this.init()};b.prototype={init:function(){this.height=this.$e.css("height");if(this.isEnabled()){this.buildEditor(true);return}this.buildEditor();this.buildButtonPane();this.fixedButtonPaneEvents();this.buildOverlay()},buildEditor:function(f){if(f===true){if(!this.$e.is("textarea")){var e=this.buildTextarea().val(this.$e.val());this.$e.hide().after(e)}return}this.$box=c("<div/>",{"class":this.opts.prefix+this.cssClass.editorBox+" "+this.opts.prefix+this.opts.lang+" trumbowyg"});this.isTextarea=true;if(this.$e.is("textarea")){this.$editor=c("<div/>")}else{this.$editor=this.$e;this.$e=this.buildTextarea().val(this.$e.val());this.isTextarea=false}this.$e.hide().addClass(this.opts.prefix+this.cssClass.editorTextarea);var g="";if(this.isTextarea){g=this.$e.val();this.$box.insertAfter(this.$e).append(this.$editor).append(this.$e)}else{g=this.$editor.html();this.$box.insertAfter(this.$editor).append(this.$e).append(this.$editor);this.syncCode()}this.$editor.addClass(this.opts.prefix+this.cssClass.editorEditor).attr("contenteditable",true).attr("dir",this.opts.dir).html(g);if(this.opts.resetCss){this.$editor.addClass(this.opts.prefix+"reset-css")}if(!this.opts.autoAjustHeight){this.$editor.css({height:this.height,overflow:"auto"});this.$e.css({height:this.height,overflow:"auto"})}var h=this;this.$editor.on("dblclick","img",function(){c(this).attr("src",h.getUrl(c(this).attr("src")));return false});this.$editor.on("mousedown",function(i){h.sementicCode()})},buildTextarea:function(){return c('<textarea name="'+this.$e.attr("id")+'"></textarea>',{height:this.height})},buildButtonPane:function(){if(this.opts.buttons===false){return}this.$buttonPane=c("<ul/>",{"class":this.opts.prefix+this.cssClass.buttonPane});c.each(this.opts.buttons.concat(this.opts.buttonsAdd),c.proxy(function(g,f){if(!c.isArray(f)){f=[f]}c.each(f,c.proxy(function(k,j){try{var h=c("<li/>");if(j=="|"){h.addClass(this.opts.prefix+this.cssClass.separator)}else{if(j=="viewHTML"){h.addClass(this.opts.prefix+this.cssClass.notDisable)}h.append(this.buildButton(j))}this.$buttonPane.append(h)}catch(l){}},this))},this));var e=c("<li/>",{"class":this.opts.prefix+this.cssClass.notDisable+" "+this.opts.prefix+this.cssClass.buttonsRight});if(this.opts.fullscreenable){e.append(this.buildRightButton("fullscreen").on("click",c.proxy(function(i){var f=this.opts.prefix+this.cssClass.fullscreen;this.$box.toggleClass(f);if(this.$box.hasClass(f)){c("body").css("overflow","hidden");this.$box.css({position:"fixed",top:0,left:0,width:"100%",height:"100%",margin:0,padding:0,zIndex:10});c([this.$editor,this.$e]).each(function(){c(this).css({height:"100%",overflow:"auto"})});this.$buttonPane.css({width:"100%"})}else{c("body").css("overflow","auto");this.$box.removeAttr("style");if(!this.opts.autoAjustHeight){var g=this.height;c([this.$editor,this.$e]).each(function(){c(this).css({height:g})})}}c(window).trigger("scroll")},this)))}if(this.opts.closable){e.append(this.buildRightButton("close").on("click",c.proxy(function(f){this.destroy()},this)))}this.$buttonPane.append(e);this.$box.prepend(this.$buttonPane)},buildButton:function(f){var j=this.opts.buttonsDef[f];var h=this;var g=c("<a/>",{href:"javascript:void(null);","class":this.opts.prefix+f+"-button",text:j.text||j.title||this.lang[f]||f,title:j.title||j.text||this.lang[f]||f,mousedown:function(l){if(!j.dropdown||h.$box.find("."+f+"-"+h.opts.prefix+h.cssClass.dropdown).is(":hidden")){c("body").trigger("mousedown")}if(h.$buttonPane.hasClass(h.opts.prefix+"disable")&&!c(this).parent().hasClass(h.opts.prefix+h.cssClass.notDisable)){return false}h.execCommand((j.dropdown?"dropdown":"")||j.func||f,j.param||f);l.stopPropagation();l.preventDefault();return false}});if(j.dropdown){var e=this.opts.prefix+this.cssClass.dropdown+" "+this.opts.prefix+this.cssClass.fixedTop;var k=c("<div/>",{"class":f+"-"+e+" "+e});k.data("visible",false);for(var i in j.dropdown){if(c.isObject(j.dropdown[i])){k.append(this.buildSubButton(j.dropdown,i))}}this.$box.append(k.hide())}return g},buildSubButton:function(g,e){c("body").trigger("mousedown");var f=g[e];return c("<a/>",{href:"javascript:void(null);",text:f.text||f.title||this.lang[e]||e,title:f.title||f.text||this.lang[e]||e,mousedown:c.proxy(function(h){c("body").trigger("mousedown");this.execCommand(g.defaultFunc||f.func||e,f.param||e);h.stopPropagation();h.preventDefault();return false},this)})},buildRightButton:function(e){return c("<a/>",{href:"javascript:void(null);","class":this.opts.prefix+(this.cssClass[e]||e)+"-button",title:this.lang[e],text:this.lang[e]})},buildOverlay:function(){return this.$overlay=c("<div/>",{"class":this.opts.prefix+"overlay"}).css({top:this.$buttonPane.css("height"),height:this.$editor.outerHeight()}).appendTo(this.$box)},showOverlay:function(){c(window).trigger("scroll");this.$overlay.fadeIn(200)},hideOverlay:function(){this.$overlay.fadeOut(200)},fixedButtonPaneEvents:function(){if(!this.opts.fixedButtonPane){return}this.isFixed=false;c(window).on("scroll",c.proxy(function(h){if(!this.$box){return}this.syncCode();var g=c(window).scrollTop();var i=this.$box.offset().top+2;var f=(g-i>0)&&((g-i-parseInt(this.height.replace("px","")))<0);if(f){if(!this.isFixed){this.isFixed=true;this.$buttonPane.css({position:"fixed",top:0,left:(this.opts.fixedFullWidth)?"0":"auto",width:(this.opts.fixedFullWidth)?"100%":this.$box.css("width"),zIndex:7});this.$editor.css({marginTop:this.$buttonPane.css("height")});this.$e.css({marginTop:this.$buttonPane.css("height")})}c("."+this.opts.prefix+this.cssClass.fixedTop,this.$box).css({position:this.opts.fixedFullWidth?"fixed":"absolute",top:this.opts.fixedFullWidth?this.$buttonPane.css("height"):parseInt(this.$buttonPane.css("height").replace("px",""))+(g-i)+"px",zIndex:15})}else{if(this.isFixed){this.isFixed=false;this.$buttonPane.css({position:"relative"});this.$editor.css({marginTop:0});this.$e.css({marginTop:0});c("."+this.opts.prefix+this.cssClass.fixedTop,this.$box).css({position:"absolute",top:this.$buttonPane.css("height")})}}},this))},destroy:function(){var e=this.getCode();if(this.isTextarea){this.$box.after(this.$e.css({height:this.height}).val(e).removeClass(this.opts.prefix+this.cssClass.editorTextarea).show())}else{this.$box.after(this.$editor.css({height:this.height}).removeClass(this.opts.prefix+this.cssClass.editorEditor).attr("contenteditable",false).html(e).show())}this.$box.remove();this.$creator.removeData("trumbowyg")},toggle:function(){this.sementicCode();this.$editor.toggle();this.$e.toggle();this.$buttonPane.toggleClass(this.opts.prefix+"disable")},dropdown:function(e){var g=this.$box.find("."+e+"-"+this.opts.prefix+this.cssClass.dropdown);var f=this.$buttonPane.find("."+this.opts.prefix+e+"-button");if(g.is(":hidden")){f.addClass(this.opts.prefix+"active");g.css({position:"absolute",top:this.$buttonPane.css("height"),left:(this.opts.fixedFullWidth&&this.isFixed)?f.offset().left+"px":(f.offset().left-this.$buttonPane.offset().left)+"px"}).show();c(window).trigger("scroll");c("body").on("mousedown",c.proxy(function(h){c("."+this.opts.prefix+this.cssClass.dropdown).hide();c("."+this.opts.prefix+"active").removeClass(this.opts.prefix+"active");c("body").off("mousedown")},this))}else{c("body").trigger("mousedown")}},getCode:function(){return this.$e.val()},setCode:function(e){this.$e.val(e)},syncCode:function(){if(this.$editor.is(":visible")){this.$e.val(this.$editor.html())}else{this.$editor.html(this.$e.val())}if(this.opts.autoAjustHeight){this.height=this.$editor.css("height");this.$e.css({height:this.height})}},sementicCode:function(){this.syncCode();if(this.opts.semantic){this.sementicTag("b","strong");this.sementicTag("i","em");this.$e.val(this.$editor.html())}},sementicTag:function(e,f){c(e,this.$editor).each(function(){c(this).replaceWith(function(){return"<"+f+">"+c(this).html()+"</"+f+">"})})},createLink:function(){var e='<label>URL : <input type="text" name="url" value="http://"></label><label>Title : <input type="text" name="title" value=""></label><label>Text : <input type="text" name="text" value=""></label>';var f=this.openModal(this.lang.createLink,e);f.on(this.opts.prefix+"confirm",c.proxy(function(j,g){var i=c(g);var h=i.find('input[name="url"]').val();var l=i.find('input[name="title"]').val();var k=i.find('input[name="text"]').val();if(h!="http://"){document.execCommand("createlink",false,h);this.syncCode();this.closeModal();f.off(this.opts.prefix+"confirm")}else{i.append('<span class="error">Invalid URL</span>')}},this));f.one(this.opts.prefix+"cancel",c.proxy(function(){f.off(this.opts.prefix+"confirm");this.closeModal()},this))},formatBlock:function(e){if(c.browser.msie){e="<"+e+">"}document.execCommand("formatBlock",false,e);this.syncCode()},insertImage:function(){var e='<label>URL : <input type="text" name="url" value="http://"></label><label>Alt : <input type="text" name="alt" value=""></label>';var f=this.openModal(this.lang.insertImage,e);f.on(this.opts.prefix+"confirm",c.proxy(function(k,g){var i=c(g);var h=i.find('input[name="url"]').val();var j=i.find('input[name="alt"]').val();if(h!="http://"){document.execCommand("insertImage",false,h);this.syncCode();this.closeModal();f.off(this.opts.prefix+"confirm")}else{i.append('<span class="error">Invalid URL</span>')}},this));f.one(this.opts.prefix+"cancel",c.proxy(function(){f.off(this.opts.prefix+"confirm");this.closeModal()},this))},execCommand:function(f,h){if(f!="dropdown"){this.$editor.focus()}try{this[f](h)}catch(g){try{f(h)}catch(g){this.$editor.focus();document.execCommand(f,false,h)}}this.syncCode()},openModal:function(h,g){this.showOverlay();this.$buttonPane.addClass(this.opts.prefix+"disable");c("."+this.opts.prefix+this.cssClass.notDisable,this.$buttonPane).not("."+this.opts.prefix+this.cssClass.buttonsRight).removeClass(this.opts.prefix+this.cssClass.notDisable).addClass(this.opts.prefix+this.cssClass.notDisable+"-old");var f=c("<div/>",{"class":this.opts.prefix+this.cssClass.modal+" "+this.opts.prefix+this.cssClass.fixedTop}).css({top:this.$buttonPane.css("height")}).appendTo(this.$box);var e=c("<div/>",{"class":this.opts.prefix+this.cssClass.modal+"-box",html:g}).css({top:"-"+f.css("height")}).appendTo(f).animate({top:0},300);c("<span/>",{text:h,"class":this.opts.prefix+this.cssClass.modal+"-title"}).prependTo(e);this.buildModalButton("cancel",e);this.buildModalButton("confirm",e);c("body").trigger("scroll");return e},buildModalButton:function(e,f){return c("<a/>",{href:"javascript:void(null);","class":this.opts.prefix+this.cssClass.modal+"-button "+this.opts.prefix+this.cssClass.modal+"-"+e,text:this.lang[e]||e,title:this.lang[e]||e,click:c.proxy(function(g){f.trigger(this.opts.prefix+e,f)},this)}).appendTo(f)},closeModal:function(){this.$buttonPane.removeClass(this.opts.prefix+"disable");c("."+this.opts.prefix+this.cssClass.notDisable+"-old",this.$buttonPane).removeClass(this.opts.prefix+this.cssClass.notDisable+"-old").addClass(this.opts.prefix+this.cssClass.notDisable);var f=this;var e=c("."+this.opts.prefix+this.cssClass.modal+"-box",this.$box);e.animate({top:"-"+e.css("height")},300,function(){c(this).parent().remove();f.hideOverlay()})},isEnabled:function(){var e="iPhone|iPod|Android|BlackBerry|WindowssPhone|ZuneWP7";var g=new RegExp("(iPad|webOS)");var f=new RegExp("("+e+")");return(this.opts.tablet===true&&g.test(navigator.userAgent))||(this.opts.mobile===true&&f.test(navigator.userAgent))}};var d=Object.prototype.toString,a=Object.prototype.hasOwnProperty;jQuery.isObject=function(f){if(d.call(f)!=="[object Object]"){return false}var e;for(e in f){}return !e||a.call(f,e)}})(jQuery);