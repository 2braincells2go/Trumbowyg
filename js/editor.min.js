$.trumbowyg={langs:{en:{viewHTML:"View HTML",formatting:"Formatting",p:"Paragraph",blockquote:"Quote",code:"Code",header:"Header",bold:"Bold",italic:"Italic",strikethrough:"Stroke",underline:"Underline",strong:"Strong",em:"Emphase",unorderedList:"Unordered list",orderedList:"Ordered list",insertImage:"Insert Image...",insertVideo:"Insert Video...",link:"Link",createLink:"Insert link...",unlink:"Remove link",justifyLeft:"Align Left",justifyCenter:"Align Center",justifyRight:"Align Right",justifyFull:"Align Justify",insertHorizontalRule:"Insert horizontal rule",fullscreen:"fullscreen",close:"Close"},fr:{viewHTML:"Voir le HTML",formatting:"Mise en page",p:"Paragraphe",blockquote:"Citation",code:"Code",header:"Titre",bold:"Gras",italic:"Italique",strikethrough:"Rayé",underline:"Souligné",strong:"Strong",em:"Emphase",unorderedList:"Liste à puces",orderedList:"Liste ordonnée",insertImage:"Inserer une Image...",insertVideo:"Inserer une Video...",link:"Lien",createLink:"Insérer un lien...",unlink:"Supprimer le lien",justifyLeft:"Aligner à gauche",justifyCenter:"Centrer",justifyRight:"Aligner à droite",justifyFull:"Justifier",insertHorizontalRule:"Insérer un séparateur horizontal",fullscreen:"Plein écran",close:"Fermer"}}};(function(a){a.fn.trumbowyg=function(c){return this.each(function(){var d=a(this);if(!d.data("trumbowyg"))d.data("trumbowyg",new b(this,c))})};a.fn.destroyTrumbowyg=function(){this.data("trumbowyg").destroy()};a.fn.getCode=function(){return this.data("trumbowyg").getCode()};var b=function(b,c){this.$e=a(b);this.$creator=a(b);if(typeof c!=="undefined"&&typeof c.lang!=="undefined"&&typeof a.trumbowyg.langs[c.lang]==="undefined")this.lang=a.trumbowyg.langs["en"];else this.lang=a.extend(true,{},a.trumbowyg.langs["en"],a.trumbowyg.langs[c.lang]);this.global={buttonsGroups:{design:["bold","italic","underline","strikethrough"],semantic:["strong","em"],justify:["justifyLeft","justifyCenter","justifyRight","justifyFull"],lists:["unorderedList","orderedList"]}};this.opts=a.extend(true,{lang:"en",dir:"ltr",mobile:false,tablet:true,closable:false,fullscreenable:true,fixedButtonPane:false,fixedFullWidth:false,semantic:false,resetCss:false,autoAjustHeight:false,cssClass:{editorBox:"box",editorEditor:"editor",editorTextarea:"textarea",buttonPane:"button-pane",separator:"separator",dropdown:"dropdown",fullscreen:"fullscreen",close:"close",notDisable:"not-disable",buttonsRight:"buttons-right"},prefix:"trumbowyg-",convertLink:true,buttons:["viewHTML","|","formatting","|",this.global.buttonsGroups.design,"|","link","|","insertImage","|",this.global.buttonsGroups.justify,"|",this.global.buttonsGroups.lists,"|","insertHorizontalRule"],buttonsAdd:[],buttonsDef:{viewHTML:{func:"toggle"},formatting:{dropdown:{defaultFunc:"formatBlock",p:{},blockquote:{},h1:{title:this.lang.header+" 1"},h2:{title:this.lang.header+" 2"},h3:{title:this.lang.header+" 3"},h4:{title:this.lang.header+" 4"}}},bold:{},italic:{},underline:{},strikethrough:{},strong:{func:"formatBlock"},em:{func:"formatBlock"},link:{dropdown:{createLink:{},unlink:{}}},insertImage:{},justifyLeft:{},justifyCenter:{},justifyRight:{},justifyFull:{},unorderedList:{func:"insertUnorderedList"},orderedList:{func:"insertOrderedList"},insertHorizontalRule:{}}},c);if(this.opts.semantic){this.opts.buttons=["viewHTML","|","formatting","|",this.global.buttonsGroups.semantic,"|","link","|","insertImage","|",this.global.buttonsGroups.justify,"|",this.global.buttonsGroups.lists,"|","insertHorizontalRule"]}this.init()};b.prototype={init:function(){this.height=this.$e.css("height");if(this.isEnabled()){this.buildEditor(true);return}this.buildEditor();this.buildButtonPane();if(this.opts.fixedButtonPane){this.isFixed=false;a(window).on("scroll",a.proxy(function(b){if(!this.$box)return;this.syncCode();var c=a(window).scrollTop();var d=this.$box.offset().top+2;var e=c-d>0&&c-d-parseInt(this.height.replace("px",""))<0;if(e){if(!this.isFixed){this.isFixed=true;this.$buttonPane.css({position:"fixed",top:0,left:this.opts.fixedFullWidth?"0":"auto",width:this.opts.fixedFullWidth?"100%":this.$box.css("width"),zIndex:10});this.$editor.css({marginTop:this.$buttonPane.css("height")});this.$e.css({marginTop:this.$buttonPane.css("height")})}a("."+this.opts.prefix+this.opts.cssClass.dropdown,this.$box).css({position:this.opts.fixedFullWidth?"fixed":"absolute",top:this.opts.fixedFullWidth?this.$buttonPane.css("height"):parseInt(this.$buttonPane.css("height").replace("px",""))+(c-d)+"px",zIndex:15})}else if(this.isFixed){this.isFixed=false;this.$buttonPane.css({position:"relative"});this.$editor.css({marginTop:0});this.$e.css({marginTop:0});a("."+this.opts.prefix+this.opts.cssClass.dropdown,this.$box).css({position:"absolute",top:this.$buttonPane.css("height")})}},this))}},buildEditor:function(b){if(b===true){if(!this.$e.is("textarea")){var c=this.buildTextarea().val(this.$e.val());this.$e.hide().after(c)}return}this.$box=a("<div/>",{"class":this.opts.prefix+this.opts.cssClass.editorBox+" "+this.opts.prefix+this.opts.lang+" trumbowyg"});this.isTextarea=true;if(this.$e.is("textarea")){this.$editor=a("<div/>")}else{this.$editor=this.$e;this.$e=this.buildTextarea().val(this.$e.val());this.isTextarea=false}this.$e.hide().addClass(this.opts.prefix+this.opts.cssClass.editorTextarea);var d="";if(this.isTextarea){d=this.$e.val();this.$box.insertAfter(this.$e).append(this.$editor).append(this.$e)}else{d=this.$editor.html();this.$box.insertAfter(this.$editor).append(this.$e).append(this.$editor);this.syncCode()}this.$editor.addClass(this.opts.prefix+this.opts.cssClass.editorEditor).attr("contenteditable",true).attr("dir",this.opts.dir).html(d);if(this.opts.resetCss)this.$editor.addClass(this.opts.prefix+"reset-css");if(!this.opts.autoAjustHeight){this.$editor.css({height:this.height,overflow:"auto"});this.$e.css({height:this.height,overflow:"auto"})}var e=this;this.$editor.on("dblclick","img",function(){a(this).attr("src",e.getUrl(a(this).attr("src")));return false})},buildTextarea:function(){return a('<textarea name="'+this.$e.attr("id")+'"></textarea>',{height:this.height})},buildButtonPane:function(){if(this.opts.buttons===false)return;this.$buttonPane=a("<ul/>",{"class":this.opts.prefix+this.opts.cssClass.buttonPane});a.each(this.opts.buttons.concat(this.opts.buttonsAdd),a.proxy(function(b,c){if(!a.isArray(c))c=[c];a.each(c,a.proxy(function(b,c){try{var d=a("<li/>");if(c=="|"){d.addClass(this.opts.prefix+this.opts.cssClass.separator)}else{if(c=="viewHTML")d.addClass(this.opts.prefix+this.opts.cssClass.notDisable);d.append(this.buildButton(c))}this.$buttonPane.append(d)}catch(e){}},this))},this));var b=a("<li/>",{"class":this.opts.prefix+this.opts.cssClass.notDisable+" "+this.opts.prefix+this.opts.cssClass.buttonsRight});if(this.opts.fullscreenable){b.append(a("<a/>",{href:"javascript:void(null);","class":this.opts.prefix+this.opts.cssClass.fullscreen+"-button",title:this.lang.fullscreen,text:this.lang.fullscreen,click:a.proxy(function(a){this.$box.toggleClass(this.opts.prefix+this.opts.cssClass.fullscreen)},this)}))}if(this.opts.closable){b.append(a("<a/>",{href:"javascript:void(null);","class":this.opts.prefix+this.opts.cssClass.close+"-button",title:this.lang.close,text:this.lang.close,click:a.proxy(function(a){this.destroy()},this)}))}this.$buttonPane.append(b);this.$box.prepend(this.$buttonPane)},buildButton:function(b){var c=this.opts.buttonsDef[b];var d=a("<a/>",{href:"javascript:void(null);","class":this.opts.prefix+b+"-button",text:c.text||c.title||this.lang[b]||b,title:c.title||c.text||this.lang[b]||b,mousedown:a.proxy(function(d){if(!c.dropdown||this.$box.find("."+b+"-"+this.opts.prefix+this.opts.cssClass.dropdown).is(":hidden"))a("body").trigger("mousedown");if(this.$buttonPane.hasClass(this.opts.prefix+"disable")&&b!="viewHTML")return false;this.execCommand((c.dropdown?"dropdown":"")||c.func||b,c.param||b);d.stopPropagation();d.preventDefault();return false},this)});if(c.dropdown){var e=this.opts.prefix+this.opts.cssClass.dropdown;var f=a("<div/>",{"class":b+"-"+e+" "+e});f.data("visible",false);for(var g in c.dropdown){if(a.isObject(c.dropdown[g]))f.append(this.buildSubButton(c.dropdown,g))}this.$box.append(f.hide())}return d},buildSubButton:function(b,c){a("body").trigger("mousedown");var d=b[c];return a("<a/>",{href:"javascript:void(null);",text:d.text||d.title||this.lang[c]||c,title:d.title||d.text||this.lang[c]||c,mousedown:a.proxy(function(e){a("body").trigger("mousedown");this.execCommand(b.defaultFunc||d.func||c,d.param||c);e.stopPropagation();e.preventDefault();return false},this)})},toggle:function(){this.syncCode();this.$editor.toggle();this.$e.toggle();this.$buttonPane.toggleClass(this.opts.prefix+"disable")},dropdown:function(b){var c=this.$box.find("."+b+"-"+this.opts.prefix+this.opts.cssClass.dropdown);var d=this.$buttonPane.find("."+this.opts.prefix+b+"-button");if(c.is(":hidden")){d.addClass(this.opts.prefix+"active");c.css({position:"absolute",top:this.$buttonPane.css("height"),left:this.opts.fixedFullWidth&&this.isFixed?d.offset().left+"px":d.offset().left-this.$buttonPane.offset().left+"px"}).show();a(window).trigger("scroll");a("body").on("mousedown",a.proxy(function(b){a("."+this.opts.prefix+this.opts.cssClass.dropdown).hide();a("."+this.opts.prefix+"active").removeClass(this.opts.prefix+"active");a("body").off("mousedown")},this))}else{a("body").trigger("mousedown")}},destroy:function(){var a=this.getCode();if(this.isTextarea)this.$box.after(this.$e.css({height:this.height}).val(a).removeClass(this.opts.prefix+this.opts.cssClass.editorTextarea).show());else this.$box.after(this.$editor.css({height:this.height}).removeClass(this.opts.prefix+this.opts.cssClass.editorEditor).attr("contenteditable",false).html(a).show());this.$box.remove();this.$creator.removeData("trumbowyg")},getCode:function(){return this.$e.val()},setCode:function(a){this.$e.val(a)},syncCode:function(){this.height=this.$editor.css("height");if(this.$editor.is(":visible"))this.$e.val(this.$editor.html()).css({height:this.height});else this.$editor.html(this.$e.val())},createLink:function(){var a=this.getUrl();if(a)document.execCommand("createlink",false,a);this.syncCode()},formatBlock:function(b){if(a.browser.msie)b="<"+b+">";document.execCommand("formatBlock",false,b);this.syncCode()},insertImage:function(){var a=this.getUrl();if(a)document.execCommand("insertImage",false,a);this.syncCode()},getUrl:function(a){var b="http://";do{b=prompt("URL : ",a?a:b)}while(b=="http://");return b?b:false},execCommand:function(a,b){if(a!="dropdown")this.$editor.focus();try{this[a](b)}catch(c){try{a(b)}catch(c){this.$editor.focus();document.execCommand(a,false,b)}}this.syncCode()},isEnabled:function(){var a="iPhone|iPod|Android|BlackBerry|Windows Phone|ZuneWP7";var b=new RegExp("(iPad|webOS|"+a+")");var c=new RegExp("("+a+")");return this.opts.tablet===true&&b.test(navigator.userAgent)||this.opts.mobile===true&&c.test(navigator.userAgent)}};var c=Object.prototype.toString,d=Object.prototype.hasOwnProperty;jQuery.isObject=function(a){if(c.call(a)!=="[object Object]")return false;var b;for(b in a){}return!b||d.call(a,b)}})(jQuery)